# Booking Session Foreign Key Error Investigation
**Date:** 2025-10-17  
**Status:** IN PROGRESS - Awaiting Render deployment to test debug endpoints

## Problem Statement
API call to create booking session fails with foreign key constraint error:
```
insert or update on table "booking_sessions" violates foreign key constraint "booking_sessions_cruise_id_fkey"
```

## Environment
- **Testing URL:** https://zipsea-backend.onrender.com/api/v1/booking/session
- **Database:** Production PostgreSQL (dpg-d2idqjjipnbc73abma3g-a.oregon-postgres.render.com)
- **Branch:** main (staging backend)

## Investigation Timeline

### 1. Initial Testing (Failed)
```bash
curl -X POST https://zipsea-backend.onrender.com/api/v1/booking/session \
  -d '{"cruiseId": "2186855", "passengerCount": {"adults": 2, "children": 0, "childAges": []}}'
# Result: Foreign key constraint error
```

### 2. Database Verification (✅ All Passed)
Verified production database structure:

**a) Cruise exists:**
```sql
SELECT * FROM cruises WHERE id = '2186855';
-- Result: 1 row returned ✅
```

**b) Table structures:**
- `cruises.id` = VARCHAR(50) - primary key
- `booking_sessions.cruise_id` = VARCHAR(255) - foreign key references cruises(id)
- Foreign key constraint exists and is correct ✅

**c) Manual SQL insert:**
```sql
INSERT INTO booking_sessions (...) VALUES (..., '2186855', ...) RETURNING id;
-- Result: SUCCESS ✅
```

### 3. Schema Definition Verification (✅ Correct)
**Drizzle Schema (`booking-sessions.ts`):**
```typescript
cruiseId: varchar('cruise_id')
  .references(() => cruises.id)
  .notNull(),
```

**Database Foreign Key:**
```
booking_sessions_cruise_id_fkey FOREIGN KEY (cruise_id) REFERENCES cruises(id)
```

### 4. Local Testing (✅ SUCCESS!)
Started local backend (connects to production database):
```bash
curl -X POST http://localhost:3001/api/v1/booking/session \
  -d '{"cruiseId": "2239817", "passengerCount": {...}}'
# Result: SUCCESS - Session created ✅
```

**SQL Generated by Drizzle (from logs):**
```sql
insert into "booking_sessions" (..., "cruise_id", ...) values (..., $3, ...)
Params: [..., '2239817', ...]  -- Note: STRING with quotes ✅
```

**Verification in database:**
```sql
SELECT * FROM booking_sessions ORDER BY created_at DESC LIMIT 1;
-- Result: Local insert succeeded, cruise_id = '2239817' ✅
```

### 5. Production API Re-test (❌ Still Fails)
```bash
curl -X POST https://zipsea-backend.onrender.com/api/v1/booking/session \
  -d '{"cruiseId": "2239817", ...}'
# Result: STILL FAILS with foreign key error ❌
```

## Key Discovery
**CRITICAL:** Local backend successfully inserts into production database, but deployed Render backend fails with same database. This proves:

✅ Database schema is correct  
✅ Cruise data exists  
✅ Foreign key constraint is properly defined  
✅ Drizzle code is correct  
✅ SQL generation is correct  

❌ **Issue is with the deployed Render backend specifically**

## Hypothesis
The deployed backend on Render has one of these issues:

1. **Different Database Connection:** Despite environment variables, might be connecting to old/different database
2. **Stale Build Cache:** Compiled TypeScript might have old schema definitions cached
3. **Module Loading Issue:** Drizzle schema might be loading from unexpected location
4. **Environment Difference:** Some environment variable or configuration causing type coercion

## Debug Actions Taken

### Added Comprehensive Logging
**Files modified:**
- `backend/src/controllers/booking.controller.ts` - Log received cruiseId and type
- `backend/src/services/traveltek-session.service.ts` - Log values before DB insert
- `backend/src/db/connection.ts` - Enable Drizzle SQL query logging

**Commits:**
- `141fd72` - Add detailed logging to trace cruiseId
- `83f4738` - Enable Drizzle SQL query logging

### Created Debug Routes  
**File:** `backend/src/routes/debug.routes.ts`

**Endpoints:**
1. `POST /api/v1/debug/test-booking-session-raw` 
   - Bypasses Drizzle, uses raw postgres-js SQL
   - Tests if issue is with Drizzle or database
   
2. `GET /api/v1/debug/db-info`
   - Shows which database backend is actually connected to
   - Shows cruise and session counts

**Commit:** `500b3c4` - Add raw SQL test routes

## Next Steps (Waiting for Deployment)

1. ⏳ Wait for Render to deploy debug routes (commit 500b3c4)
2. Test `/api/v1/debug/db-info` to verify which database is connected
3. Test `/api/v1/debug/test-booking-session-raw` with cruiseId "2239817"
4. Compare raw SQL result vs Drizzle result
5. Check Render deployment logs for SQL query output
6. Based on findings, implement fix

## Deployment Info
- **Service:** zipsea-backend-staging (from render.yaml)
- **Branch:** main
- **Database:** Should be zipsea-postgres-production (manually configured)
- **Auto-deploy:** Enabled
- **Build command:** npm install && npm run build
- **Start command:** npm start

## Test Cruises (Royal Caribbean - Line ID 22)
- `2239817` - Verified exists in production DB
- `2143913` - Verified exists in production DB
- `2186855` - Verified exists in production DB

## Open Questions
1. Why does local backend work but deployed doesn't?
2. Is Render backend connecting to correct database?
3. Is there a build cache issue on Render?
4. Are there different Drizzle schema files being loaded?

## Files Changed This Session
- `backend/src/controllers/booking.controller.ts` - Added logging
- `backend/src/services/traveltek-session.service.ts` - Added logging  
- `backend/src/db/connection.ts` - Enabled SQL logging
- `backend/src/routes/debug.routes.ts` - NEW debug endpoints
- `backend/src/routes/index.ts` - Mount debug routes

## Related Documentation
- `TRAVELTEK-LIVE-BOOKING-API.md` - Traveltek API documentation
- `journal/2025-10-17-live-booking-integration-session.md` - Previous session context
